<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Steve Weston (originally for package iterators)" />
<meta name="author" content="Peter Meilstrup (adapted for package iterors)" />


<title>Writing Custom Iterators</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Writing Custom Iterators</h1>
<h4 class="author">Steve Weston (originally for package <code>iterators</code>)</h4>
<h4 class="author">Peter Meilstrup (adapted for package <code>iterors</code>)</h4>



<p>An <em>iterator</em> is a special type of object that supplies data on demand, one element <a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> at a time. This is a nice abstraction that can help simplify many programs. Iterators are particularly useful in parallel computing, since they facilitate splitting a problem into smaller pieces that can then be executed in parallel.</p>
<p>Iterators can also be used to reduce the total memory that is needed at any one time. For example, if you want to process the lines of text in a file, it is common to write a loop that reads the file one line at a time, rather than reading the entire file in order to avoid running out of memory on huge files. That’s the basic idea of iterators. Iterators provide a standard method for getting the next element, which allows us to write functions that take an iterator as an argument to provide a source of data. The function doesn’t need to know what kind of iterator it is. It just needs to know how to get another piece of data. The data could be coming from a file, a database, a vector, or it could be dynamically generated.</p>
<p>There are a number of iterators that come in the <code>iterors</code> package. The <code>iteror.array</code> method allows you to iterate over arrays, in much the same way as the standard <code>apply</code> function. <code>apply</code> has fixed rules on how the results are returned, which may require you to reshape the results, which can be inefficient, as well as inconvenient. But since <code>i_apply</code> doesn’t process any data or combine the results, it is more flexible. You can use <code>i_apply</code> with the <code>foreach</code> package to perform a parallel <code>apply</code> operation, and combine the results any way you want via the <code>.combine</code> argument to <code>foreach</code>.</p>
<p>Another iterator that comes in the <code>iterors</code> package is the <code>isplit</code> function, which works much like the standard <code>split</code> function. <code>split</code> returns a list containing all of the data divided into groups. <code>isplit</code> only generates one group at a time, as they are needed, which can reduce the amount memory that is needed.</p>
<p>But of course, there will be times when you need an iterator that isn’t provided by the <code>iterors</code> package. That is when you need to write your own custom iterator. Fortunately, that is fairly easy to do.</p>
<div id="what-methods-are-needed-for-an-iteror" class="section level2">
<h2>What methods are needed for an iteror?</h2>
<p>Basically, an <code>iteror</code> is an S3 object whose base class is <code>&quot;iteror&quot;</code>, which has defined methods called <code>nextOr</code> and <code>iteror</code>.</p>
<p>The function <code>iteror</code> is a generic method. The purpose of the <code>iteror</code> method is to construct an iterator for the specified object. For example, this makes an iteror <code>it</code> out of a list:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">it &lt;-<span class="st"> </span><span class="kw">iteror</span>(<span class="kw">list</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">3</span><span class="op">:</span><span class="dv">4</span>))</a></code></pre></div>
<p>When <code>iteror</code> is called on a list (or any object without a class) it finds the method <code>iteror.default</code>, which constructs an iterator which returns one element at a time from the given vector.</p>
<p>If <code>x</code> is already of class <code>&quot;iteror&quot;</code> then <code>iteror(x)</code> simply returns <code>x</code>, which seems odd at first. But the <code>iteror</code> method can be defined for other objects that don’t define a <code>nextOr</code> method. We call those objects <em>iterables</em>, meaning that you can iterate over them. The <code>iterators</code> package defines <code>iteror</code> methods for vectors, lists, matrices, and data frames, making those objects iterables. By defining an <code>iteror</code> method for data types, you can pass those types directly to any function that expects an iterable.</p>
<p>If you want to create an iterator for some existing class, you can do that by writing an <code>iteror</code> method that constructs an appropriate iterator. The alternative is to write your own function that takes arbitrary arguments, and returns an iterator. You can choose whichever method is most natural.</p>
<p>The most important method required for iterators is <code>nextOr(obj, or)</code>. Given an iteror <code>obj</code>, this simply returns the next value, or forces and returns its second argument <code>or.</code> Returning the value of <code>or=</code> indicates that there are no more values available in the iterator. There is (by design) no default value for <code>or</code>; you need to specify one.</p>
<p>Above we created an iterator from a list; we can now call <code>nextOr</code> on that iterator to get the values from the list:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">nextOr</span>(it, <span class="ot">NULL</span>)</a></code></pre></div>
<pre><code>## [1] 1 2</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">nextOr</span>(it, <span class="ot">NULL</span>)</a></code></pre></div>
<pre><code>## [1] 3 4</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">nextOr</span>(it, <span class="ot">NULL</span>)</a></code></pre></div>
<pre><code>## NULL</code></pre>
<p>This shows how <code>nextOr</code> behaves at the stop of iteration, returning whatever value was given to argument <code>or</code>. Here we specified NULL, but we will later see other ways to use the second argument.</p>
</div>
<div id="handling-the-end-of-iteration" class="section level2">
<h2>Handling the end of iteration</h2>
<p>In many situations, you will be dealing with effectively finite data, but data for which you don’t necessarily know the length. So if you extract values one at a time from an iterator, you need to handle the case where there isn’t a next value. This is where the <code>iterors</code> package improves on <code>iterators</code> by giving you a few options for how to respond to the end of iteration.</p>
<div id="breaking-out-of-a-loop-at-end-of-iteration" class="section level3">
<h3>Breaking out of a loop at end of iteration</h3>
<p>If you are consuming an iterator in a loop, the easiest (and often fastest) way to respond to the end of iteration so to break out of the loop. You just put a break directly in the second argument of <code>nextOr</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">x &lt;-<span class="st"> </span><span class="kw">icount</span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="cf">repeat</span> {</a>
<a class="sourceLine" id="cb8-3" title="3">  <span class="kw">print</span>(<span class="kw">nextOr</span>(x, <span class="cf">break</span>))</a>
<a class="sourceLine" id="cb8-4" title="4">}</a></code></pre></div>
<pre><code>## [1] 1
## [1] 2
## [1] 3
## [1] 4
## [1] 5
## [1] 6
## [1] 7
## [1] 8
## [1] 9
## [1] 10</code></pre>
<p>Because the <code>or</code> argument is lazily evaluated, the <code>break</code> does not execute until <code>nextOr</code> evaluates its second argument. You can put any code into the <code>or</code> argument, which will come in useful below.</p>
</div>
<div id="detecting-end-of-iteration-with-a-sentinel-value" class="section level3">
<h3>Detecting end of iteration with a sentinel value</h3>
<p>Sometimes a break or return isn’t the right action to take. As we saw above, <code>nextOr</code> will return its second argument (whatever that is) to signal end of iteration, when the iterator contains no more data. So you can check whether the returned value is the same as the one you provided, and interpret that as the end of iteration.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">x &lt;-<span class="st"> </span><span class="kw">icount</span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb10-2" title="2"><span class="cf">while</span> (<span class="op">!</span><span class="kw">is.null</span>(val &lt;-<span class="st"> </span><span class="kw">nextOr</span>(x, <span class="ot">NULL</span>))) {</a>
<a class="sourceLine" id="cb10-3" title="3">  <span class="kw">print</span>(val)</a>
<a class="sourceLine" id="cb10-4" title="4">}</a></code></pre></div>
<pre><code>## [1] 1
## [1] 2
## [1] 3
## [1] 4
## [1] 5
## [1] 6
## [1] 7
## [1] 8
## [1] 9
## [1] 10</code></pre>
<p>Here, if <code>nextOr</code> returns <code>NULL</code>, the <code>while</code> loop will exit. A special value used like <code>NULL</code> is used above, is often called a <em>sentinel value</em>.</p>
<div id="unsafe-sentinel-values" class="section level4">
<h4>Unsafe sentinel values</h4>
<p>It’s popular to use <code>NULL</code> as a sentinel, but it’s worth considering what would happen if there were an iterator that legitimately returns <code>NULL</code> as a value. For instance, this list contains some tricky values:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">bad_values &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="kw">quote</span>(.StopIteration),</a>
<a class="sourceLine" id="cb12-3" title="3">  <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb12-4" title="4">  <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb12-5" title="5">  <span class="kw">list</span>(),</a>
<a class="sourceLine" id="cb12-6" title="6">  <span class="kw">simpleError</span>(<span class="st">&quot;StopIteration&quot;</span>),</a>
<a class="sourceLine" id="cb12-7" title="7">  <span class="kw">try</span>(<span class="kw">stop</span>(<span class="st">&quot;StopIteration&quot;</span>, <span class="dt">call.=</span><span class="ot">FALSE</span>), <span class="dt">silent=</span><span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb12-8" title="8">  <span class="st">&quot;&quot;</span>,</a>
<a class="sourceLine" id="cb12-9" title="9">  <span class="kw">numeric</span>(<span class="dv">0</span>))</a></code></pre></div>
<p>Suppose you iterate over this list using NULL as your end-of-iteration sentinel, like this:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">it &lt;-<span class="st"> </span><span class="kw">iteror</span>(bad_values)</a>
<a class="sourceLine" id="cb13-2" title="2"><span class="cf">while</span> (<span class="op">!</span><span class="kw">is.null</span>(val &lt;-<span class="st"> </span><span class="kw">nextOr</span>(it, <span class="ot">NULL</span>))) {</a>
<a class="sourceLine" id="cb13-3" title="3">  <span class="kw">print</span>(val)</a>
<a class="sourceLine" id="cb13-4" title="4">}</a></code></pre></div>
<pre><code>## .StopIteration
## [1] NA</code></pre>
<p>The enumeration stops early because it mistakes <code>NULL</code>, a legitimate value in the list that we are iterating over, for <code>NULL</code> the sentinel value. This is a general problem with the sentinel value scheme in dynamically-typed languages; any value you could use to signal a stop, could also be a legitimate value for an iterator to emit.</p>
</div>
<div id="safe-sentinel-values" class="section level4">
<h4>Safe sentinel values</h4>
<p>A way to escape this problem is to construct a one-shot, <em>unique</em> sentinel value to use locally, just with this iteror, and then throw away, not keeping it in your code. One easy way to do this by using <code>new.env()</code>. Consuming an iterator using a local sentinel value looks like this:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">end_sentinel &lt;-<span class="st"> </span><span class="kw">new.env</span>()</a>
<a class="sourceLine" id="cb15-2" title="2">it &lt;-<span class="st"> </span><span class="kw">iteror</span>(bad_values)</a>
<a class="sourceLine" id="cb15-3" title="3"><span class="cf">repeat</span> {</a>
<a class="sourceLine" id="cb15-4" title="4">  val &lt;-<span class="st"> </span><span class="kw">nextOr</span>(it, end_sentinel)</a>
<a class="sourceLine" id="cb15-5" title="5">  <span class="cf">if</span> (<span class="kw">identical</span>(val, end_sentinel)) <span class="cf">break</span></a>
<a class="sourceLine" id="cb15-6" title="6">  <span class="kw">print</span>(val)</a>
<a class="sourceLine" id="cb15-7" title="7">}</a></code></pre></div>
<pre><code>## .StopIteration
## [1] NA
## NULL
## list()
## &lt;simpleError: StopIteration&gt;
## [1] &quot;Error : StopIteration\n&quot;
## attr(,&quot;class&quot;)
## [1] &quot;try-error&quot;
## attr(,&quot;condition&quot;)
## &lt;simpleError: StopIteration&gt;
## [1] &quot;&quot;
## numeric(0)</code></pre>
<p>Because environments compare by reference, a newly constructed environment is guaranteed not to be <code>identical()</code> to any other object in the R session, and the check for identity is very fast (just a pointer comparison.) By using a locally generated, unique sentinel value you avoid mistaking a legitimate value in your data for the end of iteration.</p>
</div>
</div>
</div>
<div id="a-simple-iterator" class="section level2">
<h2>A simple iterator</h2>
<p>It’s time to show the implementation of a very simple iterator. Although I’ve made it sound like you have to write your own <code>nextOr</code> methods, you can use a standard one. In fact, that’s what all of the following examples do. The method <code>iteror.function</code> takes a function you specify and wraps it in an object with class <code>iteror</code>, which has a <code>nextOr</code> method defined.</p>
<p>Now here’s a function that creates a very simple iterator, one that returns the same value <code>x</code> indefinitely.:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">iforever &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb17-2" title="2">  nextOr_ &lt;-<span class="st"> </span><span class="cf">function</span>(or) x</a>
<a class="sourceLine" id="cb17-3" title="3">  <span class="kw">iteror</span>(nextOr_)</a>
<a class="sourceLine" id="cb17-4" title="4">}</a></code></pre></div>
<p>Note that I called the internal function <code>nextOr_</code> with an underscore, rather than <code>nextOr</code>. I do that by convention to avoid masking the standard <code>nextOr</code> generic function. That would cause problems when you want your iterator to call the <code>nextOr</code> method of another iterator, which can be quite useful, as we’ll see in a later example.</p>
<p>We create an instance of this iterator by calling the <code>iforever</code> function, and then use it by calling the <code>nextOr</code> method on the resulting object:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">it &lt;-<span class="st"> </span><span class="kw">iforever</span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb18-2" title="2"><span class="kw">nextOr</span>(it, <span class="ot">NULL</span>)</a></code></pre></div>
<pre><code>## [1] 42</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1"><span class="kw">nextOr</span>(it, <span class="ot">NULL</span>)</a></code></pre></div>
<pre><code>## [1] 42</code></pre>
<p>You can also get values from an iterator using <code>as.numeric</code>. But since this is an infinite iterator, you need to also give an argument <code>n</code> argument to avoid getting stuck in an infinite loop until you run out of memory:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1"><span class="kw">as.numeric</span>(it, <span class="dt">n=</span><span class="dv">6</span>)</a></code></pre></div>
<pre><code>## [1] 42 42 42 42 42 42</code></pre>
<p>Notice that it doesn’t make sense to implement this iterator by defining a new <code>iteror</code> method, since there is no natural iterable to dispatch on; the argument 42 is just a vector of length 1 and <code>iterator.default</code> already handles that case. So instead, we implement this iterator by defining a normal function that returns the iterator.</p>
<p>This iterator is quite simple to implement, and possibly even useful. <a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> The iterator returned by <code>iforever</code> is actually just the same function you provided, with the class <code>iteror</code> added. This means you get <code>nextOr</code> method already defined, whlch just delegates to your given function. Additionally since the returned object has class <code>iteror</code>, it inherits an <code>iteror</code> method that will return itself.</p>
<p>Of course, the reason this iterator is so simple is because it doesn’t contain any state. Most iterators need to contain some state, or it will be difficult to make it return different values and eventually stop. Managing the state is usually the real trick to writing iterators.</p>
</div>
<div id="a-stateful-iterator-that-stops" class="section level2">
<h2>A stateful iterator that stops</h2>
<p>Let’s modify the previous iterator <code>iforever</code> to stop after it returns a certain number of values. I’ll call the new function <code>irep</code>, and give it another argument called <code>times</code>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">irep &lt;-<span class="st"> </span><span class="cf">function</span>(x, times) {</a>
<a class="sourceLine" id="cb24-2" title="2">  nextOr_ &lt;-<span class="st"> </span><span class="cf">function</span>(or) {</a>
<a class="sourceLine" id="cb24-3" title="3">    <span class="cf">if</span> (times <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb24-4" title="4">      times &lt;&lt;-<span class="st"> </span>times <span class="op">-</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb24-5" title="5">      x</a>
<a class="sourceLine" id="cb24-6" title="6">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb24-7" title="7">      or</a>
<a class="sourceLine" id="cb24-8" title="8">    }</a>
<a class="sourceLine" id="cb24-9" title="9">  }</a>
<a class="sourceLine" id="cb24-10" title="10"></a>
<a class="sourceLine" id="cb24-11" title="11">  <span class="kw">iteror</span>(nextOr_)</a>
<a class="sourceLine" id="cb24-12" title="12">}</a></code></pre></div>
<p>Now let’s try it out:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1">it &lt;-<span class="st"> </span><span class="kw">irep</span>(<span class="dv">7</span>, <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb25-2" title="2"><span class="kw">unlist</span>(<span class="kw">as.list</span>(it))</a></code></pre></div>
<pre><code>## [1] 7 7 7 7 7 7</code></pre>
<p>The differences between <code>iforever</code> and <code>irep</code> are in the inner function <code>nextOr_</code>. This inner function not only accesses the values of the variables <code>x</code> and <code>times</code>, but it also modifies the value of <code>times</code>. This is accomplished by means of the “<code>&lt;&lt;-=</code>”<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a> operator, and the rules of lexical scoping.</p>
<p>After enough calls, the inner function will find <code>times &lt;= 0</code>, and will return its argument <code>or</code>. As the author of an iterator this is how you signal end of iteration. When implementing an iterator you never need to do anything with <code>or</code> other than return it when appropriate; otherwise leave it alone, allowing R to be lazy in treating that argument.</p>
<p>Technically, this kind of function that refers to enclosing variables is called a <em>closure</em>, and is a fundamental feature of <code>R</code>. The important thing to remember is that <code>nextOr_</code> is able to get the value of variables that were passed as arguments to <code>irep</code>, and it can modify those values using the <code>&lt;&lt;-</code> operator. These are <em>not</em> global variables: they are defined in the enclosing environment of the <code>nextOr_</code> function. You can create as many iterators as you want using the <code>irep</code> function, and they will all work as expected without conflicts.</p>
<p>Note that this iterator only uses the arguments to <code>irep</code> to store its state. If any other state variables are needed, they can be defined anywhere inside the <code>irep</code> function.</p>
</div>
<div id="using-an-iterator-inside-an-iterator" class="section level2">
<h2>Using an iterator inside an iterator</h2>
<p>The previous section described a general way of writing custom iterators. Almost any iterator can be written using those basic techniques. At times, it may be simpler to make use of an existing iterator to implement a new iterator. Let’s say that you need an iterator that splits a vector into subvectors. That can allow you to process the vector in parallel, but still use vector operations, which is essential to getting good sequential performance in R. The following function returns just such an iterator:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1">ivector &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb27-2" title="2"> i &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb27-3" title="3"> it &lt;-<span class="st"> </span><span class="kw">idiv</span>(<span class="kw">length</span>(x), ...)</a>
<a class="sourceLine" id="cb27-4" title="4"></a>
<a class="sourceLine" id="cb27-5" title="5"> nextOr_ &lt;-<span class="st"> </span><span class="cf">function</span>(or) {</a>
<a class="sourceLine" id="cb27-6" title="6">   n &lt;-<span class="st"> </span><span class="kw">nextOr</span>(it, <span class="kw">return</span>(or))</a>
<a class="sourceLine" id="cb27-7" title="7">   ix &lt;-<span class="st"> </span><span class="kw">seq</span>(i, <span class="dt">length=</span>n)</a>
<a class="sourceLine" id="cb27-8" title="8">   i &lt;&lt;-<span class="st"> </span>i <span class="op">+</span><span class="st"> </span>n</a>
<a class="sourceLine" id="cb27-9" title="9">   x[ix]</a>
<a class="sourceLine" id="cb27-10" title="10"> }</a>
<a class="sourceLine" id="cb27-11" title="11"></a>
<a class="sourceLine" id="cb27-12" title="12"> <span class="kw">iteror</span>(nextOr_)</a>
<a class="sourceLine" id="cb27-13" title="13">}</a></code></pre></div>
<p><code>ivector</code> uses <code>...</code> to pass options on to <code>idiv</code>. <code>idiv</code> supports the <code>chunks</code> argument to split its argument into a specified number of pieces, and the <code>chunkSize</code> argument to split it into pieces of a specified maximum size.</p>
<p>Let’s create an <code>ivector</code> iterator to split a vector into three pieces using the <code>chunks</code> argument:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1">it &lt;-<span class="st"> </span><span class="kw">ivector</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">25</span>, <span class="dt">chunks=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb28-2" title="2"><span class="kw">as.list</span>(it)</a></code></pre></div>
<pre><code>## [[1]]
## [1] 1 2 3 4 5 6 7 8 9
## 
## [[2]]
## [1] 10 11 12 13 14 15 16 17
## 
## [[3]]
## [1] 18 19 20 21 22 23 24 25</code></pre>
<p>Note how our <code>nextOr_</code> function handles the end of iteration. If the underlying <code>idiv</code> iterator reaches the end, it will force its <code>or</code> argument, which we have specified as <code>return(or)</code>, Although it is forced by the underlying iterator, R correctly evaluates a <code>return</code> call in a lazy argument according to the scope that call was written in. So when <code>it</code> of the internal <code>idiv</code> reaches the end, and forces its <code>or</code> argument, our <code>nextOr_</code> passes that signal along by returning <em>its</em> <code>or</code> argument.</p>
<p>The <code>nextOr</code> method uses a lazy evaluated argument expressly for this purpose, so that you can respond to end of iteration by using a control flow operator like <code>return</code>, <code>break</code>, <code>next</code> or <code>stop</code>.</p>
<p>It should be clear that only minor modification need to be made to this function to create an iterator over the blocks of rows or columns of a matrix or data frame. But I’ll leave that as an exercise for the reader.</p>
</div>
<div id="a-recycling-iterator" class="section level2">
<h2>A recycling iterator</h2>
<p>You can start to compose simple iterators together to do more complex things by writing functions that take in one iterator and construct a new one. In this example, we’ll return an iterator that recycles the values of the wrapped iterator: <a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" title="1">i_recycle &lt;-<span class="st"> </span><span class="cf">function</span>(it) {</a>
<a class="sourceLine" id="cb30-2" title="2">  values &lt;-<span class="st"> </span><span class="kw">as.list</span>(<span class="kw">iteror</span>(it))</a>
<a class="sourceLine" id="cb30-3" title="3">  i &lt;-<span class="st"> </span><span class="kw">length</span>(values)</a>
<a class="sourceLine" id="cb30-4" title="4"></a>
<a class="sourceLine" id="cb30-5" title="5">  nextOr_ &lt;-<span class="st"> </span><span class="cf">function</span>(or) {</a>
<a class="sourceLine" id="cb30-6" title="6">    i &lt;&lt;-<span class="st"> </span>i <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb30-7" title="7">    <span class="cf">if</span> (i <span class="op">&gt;</span><span class="st"> </span><span class="kw">length</span>(values)) i &lt;&lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb30-8" title="8">    values[[i]]</a>
<a class="sourceLine" id="cb30-9" title="9">  }</a>
<a class="sourceLine" id="cb30-10" title="10"></a>
<a class="sourceLine" id="cb30-11" title="11">  <span class="kw">iteror</span>(nextOr_)</a>
<a class="sourceLine" id="cb30-12" title="12">}</a></code></pre></div>
<p>This is fairly nice, but note that this is another one of those infinite iterators that we need to be careful about. Also, make sure that you don’t pass an infinite iterator to <code>i_recycle</code>. That would be pointless of course, since there’s no reason to recycle an iterator that never ends. It would be possible to write this to avoid that problem by not grabbing all of the values right up front, but you would still end up saving values that will never be recycled, so I’ve opted to keep this simple.</p>
<p>Let’s try it out:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" title="1">it &lt;-<span class="st"> </span><span class="kw">i_recycle</span>(<span class="kw">icount</span>(<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb31-2" title="2"><span class="kw">unlist</span>(<span class="kw">as.list</span>(it, <span class="dt">n=</span><span class="dv">9</span>))</a></code></pre></div>
<pre><code>## [1] 1 2 3 1 2 3 1 2 3</code></pre>
</div>
<div id="limiting-infinite-iterators" class="section level2">
<h2>Limiting infinite iterators</h2>
<p>I was tempted to add an argument to the <code>i_recycle</code> function to limit the number of values that it returns, because sometimes you want to recycle for awhile, but not forever. I didn’t do that, because rather than make <code>i_recycle</code> more complicated, I decided to write another function that takes an iterator and returns a modified iterator. Functions like this are <em>composable</em>; the limiting function can be applied to any underlying iterator instead of just <code>i_recycle</code>.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1">i_limit &lt;-<span class="st"> </span><span class="cf">function</span>(it, times) {</a>
<a class="sourceLine" id="cb33-2" title="2">  it &lt;-<span class="st"> </span><span class="kw">iteror</span>(it)</a>
<a class="sourceLine" id="cb33-3" title="3"></a>
<a class="sourceLine" id="cb33-4" title="4">  nextOr_ &lt;-<span class="st"> </span><span class="cf">function</span>(or) {</a>
<a class="sourceLine" id="cb33-5" title="5">    <span class="cf">if</span> (times <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb33-6" title="6">      times &lt;&lt;-<span class="st"> </span>times <span class="op">-</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb33-7" title="7">      <span class="kw">nextOr</span>(it, or)</a>
<a class="sourceLine" id="cb33-8" title="8">    } <span class="cf">else</span></a>
<a class="sourceLine" id="cb33-9" title="9">      <span class="kw">return</span>(or)</a>
<a class="sourceLine" id="cb33-10" title="10">  }</a>
<a class="sourceLine" id="cb33-11" title="11"></a>
<a class="sourceLine" id="cb33-12" title="12">  <span class="kw">iteror</span>(nextOr_)</a>
<a class="sourceLine" id="cb33-13" title="13">}</a></code></pre></div>
<p>By convention, the <code>iterors</code> package uses the prefix <code>i_</code> for this kind of composing iterator function, and a bare <code>i</code> for functions that build an iterator based on basic data.</p>
<p>Note that this looks an awful lot like the <code>irep</code> function that we implemented previously. In fact, using <code>i_limit</code>, we can implement <code>irep</code> using <code>iforever</code> much more simply, and without duplication of code:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" title="1">irep2 &lt;-<span class="st"> </span><span class="cf">function</span>(x, times)</a>
<a class="sourceLine" id="cb34-2" title="2">  <span class="kw">i_limit</span>(<span class="kw">iforever</span>(x), times)</a></code></pre></div>
<p>To demonstrate <code>irep2</code>:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" title="1">it &lt;-<span class="st"> </span><span class="kw">irep2</span>(<span class="st">&#39;foo&#39;</span>, <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb35-2" title="2"><span class="cf">repeat</span> {</a>
<a class="sourceLine" id="cb35-3" title="3">  <span class="kw">print</span>(<span class="kw">nextOr</span>(it, <span class="cf">break</span>))</a>
<a class="sourceLine" id="cb35-4" title="4">}</a></code></pre></div>
<pre><code>## [1] &quot;foo&quot;
## [1] &quot;foo&quot;
## [1] &quot;foo&quot;</code></pre>
<p>Here’s one last example. Let’s recycle a vector three times using <code>i_limit</code>, and convert it back into a vector using <code>as.numeric</code>:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" title="1">iterable &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span></a>
<a class="sourceLine" id="cb37-2" title="2">n &lt;-<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb37-3" title="3">it &lt;-<span class="st"> </span><span class="kw">i_limit</span>(<span class="kw">i_recycle</span>(iterable), n <span class="op">*</span><span class="st"> </span><span class="kw">length</span>(iterable))</a>
<a class="sourceLine" id="cb37-4" title="4"><span class="kw">as.numeric</span>(it)</a></code></pre></div>
<pre><code>## [1] 1 2 3 1 2 3 1 2 3</code></pre>
<p>Sort of a complicated version of:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" title="1"><span class="kw">rep</span>(iterable, n)</a></code></pre></div>
<pre><code>## [1] 1 2 3 1 2 3 1 2 3</code></pre>
<p>Aren’t iterators fun?</p>
</div>
<div id="conclusion" class="section level2">
<h2>Conclusion</h2>
<p>Writing your own iterators can be quite simple, and yet is very useful and powerful. It provides a very effective way to extend the capabilities of other packages that use iterators, such as the <code>foreach</code> package. By writing iterators that wrap other iterators, it is possible to put together a powerful and flexible set of tools that work well together, and that can solve many of the complex problems that come up in parallel computing.</p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>An ``element’’ in this case can be basically any object. I don’t mean to suggest that the data is necessarily returned as scalar values, for example.<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>Be careful how you use this iterator! If you pass it to <code>foreach</code>, it will result in an infinite loop unless you pair it with a non-infinite iterator. Also, <em>never</em> pass this to the <code>as.list</code> function without the <code>n</code> argument.<a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p>It’s commonly believed that <code>&lt;&lt;-</code> is only used to set variables in the global environment, but that isn’t true. I think of it as an <em>inheriting</em> assignment operator.}<a href="#fnref3" class="footnote-back">↩</a></p></li>
<li id="fn4"><p>Actually, many of the standard <code>iteror</code> methods support a <code>recycle</code> argument. But this is a nice example, and a more general solution, since it works on any iterator.<a href="#fnref4" class="footnote-back">↩</a></p></li>
</ol>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
